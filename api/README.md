# Trading Bot API

A lightweight FastAPI backend for logging trading bot data. This API stores TradeSignals and ExecutedTrades for analysis and monitoring.

## 🚀 Features

- **TradeSignals**: Log trading signals generated by your bots
- **ExecutedTrades**: Track order execution and status updates
- **Filtering**: Query data by symbol, strategy, bot ID, status, etc.
- **Type Safety**: Full Pydantic validation for requests and responses
- **Auto Documentation**: Interactive API docs at `/docs`
- **Database Migrations**: Alembic for schema management
- **Async Support**: Built with FastAPI and async SQLAlchemy
- **Modular Structure**: Clean separation of concerns with DTOs, responses, and services

## 📋 API Endpoints

### Trade Signals

- `POST /api/v1/trade-signals` - Create new trade signal
- `GET /api/v1/trade-signals` - List trade signals with filtering
- `GET /api/v1/trade-signals/{id}` - Get specific trade signal

### Executed Trades

- `POST /api/v1/executed-trades` - Create new executed trade
- `GET /api/v1/executed-trades` - List executed trades with filtering
- `GET /api/v1/executed-trades/{id}` - Get specific executed trade
- `PATCH /api/v1/executed-trades/{id}` - Update executed trade
- `GET /api/v1/executed-trades/order/{order_id}` - Get trade by IBKR order ID

### Utility

- `GET /api/v1/health` - Health check
- `GET /` - API information

## 🛠️ Setup

### Prerequisites

- Python 3.12+
- uv (package manager)
- Docker & Docker Compose (for database)

### Installation

1. **Install dependencies**:

   ```bash
   uv sync
   ```

2. **Set up environment variables**:

   ```bash
   cp api/env.example .env
   # Edit .env with your configuration
   ```

3. **Start the database**:

   ```bash
   cd api
   docker-compose up -d postgres
   ```

4. **Run database migrations**:

   ```bash
   # Once database is running
   uv run alembic upgrade head
   ```

5. **Start the API**:

   ```bash
   # Option 1: Using the run script
   uv run python api/run.py

   # Option 2: Direct uvicorn
   uv run uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
   ```

6. **Visit the API docs**:
   - Interactive docs: http://localhost:8000/docs
   - Alternative docs: http://localhost:8000/redoc

## 📊 Database Schema

### TradeSignals Table

- Signal information (type, confidence, strength)
- Price data (current, take profit, stop loss)
- Technical indicators (JSON)
- Bot and strategy identification
- Timestamps and metadata

### ExecutedTrades Table

- IBKR order details (order ID, contract ID)
- Order information (action, quantity, type, prices)
- Execution status and fills
- Commission and P&L tracking
- Timestamps and error handling

## 🔧 Usage Examples

### Creating a Trade Signal

```python
import httpx

signal_data = {
    "symbol": "ES",
    "strategy_name": "bollinger_bands",
    "signal_type": "OPEN_LONG",
    "current_price": 4150.25,
    "take_profit": 4155.25,
    "stop_loss": 4145.25,
    "confidence": 0.85,
    "timeframe": "5min",
    "candle_timestamp": "2024-01-15T10:30:00Z",
    "bot_id": "bot_es_bollinger",
    "client_id": 1
}

async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/v1/trade-signals",
        json=signal_data
    )
    print(response.json())
```

### Creating an Executed Trade

```python
trade_data = {
    "symbol": "ES",
    "strategy_name": "bollinger_bands",
    "bot_id": "bot_es_bollinger",
    "client_id": 1,
    "order_id": 12345,
    "contract_id": 67890,
    "action": "BUY",
    "quantity": 1,
    "order_type": "LMT",
    "limit_price": 4150.25
}

async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/v1/executed-trades",
        json=trade_data
    )
    print(response.json())
```

### Querying Data

```python
# Get recent signals for ES
response = await client.get(
    "http://localhost:8000/api/v1/trade-signals",
    params={"symbol": "ES", "limit": 50}
)

# Get filled trades for a specific bot
response = await client.get(
    "http://localhost:8000/api/v1/executed-trades",
    params={"bot_id": "bot_es_bollinger", "status": "FILLED"}
)
```

## 🗄️ Database Management

### Run Migrations

```bash
uv run alembic upgrade head
```

### Create New Migration

```bash
uv run alembic revision --autogenerate -m "Description of changes"
```

### Rollback Migration

```bash
uv run alembic downgrade -1
```

## 🐳 Docker

### Start Database Only

```bash
cd api
docker-compose up -d postgres
```

### Stop Database

```bash
cd api
docker-compose down
```

### Reset Database

```bash
cd api
docker-compose down -v  # Removes volumes
docker-compose up -d postgres
uv run alembic upgrade head  # Recreate tables
```

## 🔧 Development

### Run in Development Mode

```bash
uv run python api/run.py  # Auto-reload enabled
```

### Run Tests (when added)

```bash
uv run pytest
```

### Code Formatting

```bash
uv run black api/
uv run isort api/
```

## 📁 Project Structure

```
api/
├── src/
│   └── trades/                  # Trading module
│       ├── api.py               # HTTP endpoints
│       ├── dto/                 # Request DTOs
│       │   ├── create_trade_signal_dto.py
│       │   ├── create_executed_trade_dto.py
│       │   └── update_executed_trade_dto.py
│       ├── responses/           # Response schemas
│       │   ├── trade_signal_response.py
│       │   ├── executed_trade_response.py
│       │   ├── trade_signal_summary_response.py
│       │   └── executed_trade_summary_response.py
│       └── service/             # Business logic
│           └── trades_service.py
├── database/                    # Database layer
│   ├── database.py              # Database configuration
│   └── models.py                # SQLAlchemy models
├── main.py                      # FastAPI application
├── run.py                       # Development server script
├── test_example.py              # API usage examples
├── docker-compose.yml           # Database container
├── env.example                  # Environment template
├── alembic/                     # Database migrations
└── README.md                    # This file
```

## 🌟 Integration with Trading Bots

This API is designed to work seamlessly with your trading bot architecture. Your bots can:

1. **Log signals** when strategies generate trade decisions
2. **Create trades** when orders are placed with IBKR
3. **Update trades** when order status changes (fills, cancellations)
4. **Query data** for analysis and monitoring

The API is non-blocking and designed for high-frequency updates from multiple bot instances.

## 📈 Monitoring

- Health check endpoint: `GET /api/v1/health`
- Database connection monitoring via health checks
- Request/response logging (configurable)
- Automatic API documentation

---

**Next Steps**: This API provides the foundation for trade data logging. You can extend it with additional features like real-time WebSocket updates, advanced analytics endpoints, or integration with monitoring dashboards.
